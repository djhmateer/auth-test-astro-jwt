# Auth Test Astro Session

An Astro project demonstrating session-based authentication with server-side rendering (SSR).

## âœ¨ Features

- **Session-based Authentication** using Astro's built-in session support
- **Protected Routes** with automatic login redirects
- **Redirect-after-login** functionality for seamless user experience
- **Centralized Authentication** utility for code reusability
- **Session Expiration Detection** with detailed logging
- **Server-Side Rendering** with Node.js adapter
- **Filesystem Session Storage** for persistence
- **Production-ready** deployment configuration for Render.com

## ğŸš€ Project Structure

```text
/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ favicon.svg
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ *.svg
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ Welcome.astro
â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â””â”€â”€ Layout.astro
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ login.ts      # Login API endpoint
â”‚   â”‚   â”‚   â””â”€â”€ logout.ts     # Logout API endpoint
â”‚   â”‚   â”œâ”€â”€ projects/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.astro   # Protected route
â”‚   â”‚   â”‚   â””â”€â”€ project2.astro # Additional protected route
â”‚   â”‚   â”œâ”€â”€ index.astro       # Homepage
â”‚   â”‚   â””â”€â”€ login.astro       # Login form
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ auth.ts           # Centralized authentication logic
â””â”€â”€ package.json
```

## ğŸ” Authentication

The project implements session-based authentication:

### Login
- Visit `/login` to access the login form
- Default password: `1`
- Successful login creates a server-side session
- Redirects to originally requested page after authentication

### Protected Routes
- All routes under `/projects/*` require authentication (`/projects/`, `/projects/project2`)
- Unauthenticated users are redirected to `/login?redirect=<current-path>`
- After login, users return to their originally requested page
- Session data persists across requests (1-day TTL)

### Logout
- Click "Logout" button on protected pages
- Destroys server-side session
- Redirects to homepage

### Session Storage
- Uses Astro's built-in filesystem session storage
- Sessions stored in `node_modules/.astro/sessions/`
- No external database required

### Technical Details

**How Authentication Works:**
1. **Login Request**: Browser POSTs form data to `/api/login`
2. **Password Validation**: Server checks password (hardcoded as "1" for demo)
3. **Session Creation**: `session.set()` creates server-side session file
4. **Cookie Management**: Astro automatically sets HTTP-only session cookie
5. **Redirect**: 302 redirect to protected area with cookie included

**Session Cookie Details:**
- **Name**: Auto-generated by Astro (e.g., `astro-session`)
- **Content**: Session ID (UUID), not actual data
- **Security**: HTTP-only, automatically managed by Astro
- **Storage**: Session data stored server-side in filesystem

**Route Protection:**
- Protected pages import `checkAuthentication` from `src/utils/auth.ts`
- Centralized utility handles session validation and cookie expiration detection
- Missing/invalid sessions redirect to `/login?redirect=<current-path>`
- Valid sessions return authentication data (login time, current time)
- Consistent authentication behavior across all protected routes

**Logout Process:**
- `session.destroy()` deletes session file from server
- Browser cookie becomes invalid (points to non-existent data)
- User redirected to homepage and must re-authenticate

## ğŸ§ Commands

All commands are run from the root of the project:

| Command | Action |
|---------|--------|
| `pnpm install` | Install dependencies |
| `pnpm dev` | Start development server at localhost:10000 |
| `pnpm build` | Build for production to ./dist/ |
| `pnpm preview` | Preview production build locally |
| `pnpm start` | Start production server (runs built application) |
| `pnpm astro ...` | Run Astro CLI commands |

## ğŸš€ Deployment

### Render.com Configuration

This project is configured for deployment on Render.com:

- **Build Command**: `pnpm install --frozen-lockfile; pnpm run build`
- **Start Command**: `pnpm start`
- **Environment Variables**:
  - `NODE_VERSION`: `v20.3.0` (or higher)

### Server Configuration

- **Port**: Uses `process.env.PORT` or defaults to 10000
- **Host**: Binds to `0.0.0.0` for external traffic
- **Node.js Adapter**: Standalone mode for container deployment

## ğŸ› ï¸ Technology Stack

- **Framework**: Astro v5.13.10 with SSR
- **Runtime**: Node.js (>=18.0.0)
- **Package Manager**: pnpm
- **Authentication**: Astro Sessions
- **Deployment**: Render.com
- **TypeScript**: Strict configuration

## ğŸ‘€ Want to learn more?

- [Astro Documentation](https://docs.astro.build)
- [Astro Sessions Guide](https://docs.astro.build/en/guides/sessions/)
- [Node.js Adapter](https://docs.astro.build/en/guides/integrations-guide/node/)
- [Astro Discord](https://astro.build/chat)